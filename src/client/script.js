
import {ipcRenderer, webFrame} from 'electron';
import util from './lib/util.js';
import Component from './lib/component.js';

let macos = process.platform === 'darwin';
let latestResponse = null; // „Çµ„Éº„Éê„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„ÇπÔºà„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„Å™„Å©„ÇíÂê´„ÇÄÔºâ
let latestActive   = null; // „É¶„Éº„Ç∂„Éº„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åó„Åü„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
let items          = [];   // Ë™≠„ÅøËæº„Çì„Å†„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Âê´„Åæ„Çå„Çã„ÇΩ„Éº„Çπ„Ç≥„Éº„ÉâÔºà„Éá„Ç£„É¨„ÇØ„Éà„É™Ôºâ
let pages          = [];   // „Ç®„Éá„Ç£„Çø„ÇíÊ†ºÁ¥ç„Åô„Çã„Éö„Éº„Ç∏ DOM
let editors        = [];   // „Ç®„Éá„Ç£„Çø
// mode: Ace „Å´Ë®≠ÂÆö„Åô„Çã„É¢„Éº„Éâ, name: „Çµ„Éº„Éê„Åã„Çâ„ÅÆ„É¨„Çπ„Éù„É≥„Çπ„Å®„ÅÆ„Éû„ÉÉ„ÉÅ„Å´‰Ωø„ÅÜÂêçÂâç, title: „Çø„Éñ„ÅÆË°®Ë®ò
let editorMode = [
    {mode: 'html',       name: 'html', title: 'HTML'},
    {mode: 'javascript', name: 'js',   title: 'js'},
    {mode: 'glsl',       name: 'vs1',  title: 'vert(1)'},
    {mode: 'glsl',       name: 'fs1',  title: 'frag(1)'},
    {mode: 'glsl',       name: 'vs2',  title: 'vert(2)'},
    {mode: 'glsl',       name: 'fs2',  title: 'frag(2)'},
];

const FONT_SIZE           = 16;                                // Âü∫Êú¨„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫
const LIGHT_THEME         = 'ace/theme/tomorrow';              // „É©„Ç§„Éà„Éª„ÉÜ„Éº„Éû
const DARK_THEME          = 'ace/theme/tomorrow_night_bright'; // „ÉÄ„Éº„ÇØ„Éª„ÉÜ„Éº„Éû
const BUTTON_BLOCK_HEIGHT = 32;                                // „Éú„Çø„É≥È†òÂüü„ÅÆÈ´ò„Åï
const ICON_SIZE           = 16;                                // „Éú„Çø„É≥„ÅÆÂ§ß„Åç„Åï
const ICON_MARGIN         = '8px 7px';                         // „Éú„Çø„É≥„ÅÆ‰ΩôÁôΩ
// Ace „Å´Ë®≠ÂÆö„Åô„Çã„Ç™„Éó„Ç∑„Éß„É≥
const EDITOR_OPTION = {
    highlightActiveLine: true,
    highlightSelectedWord: true,
    useSoftTabs: true,
    navigateWithinSoftTabs: true,
    vScrollBarAlwaysVisible: true,
    autoScrollEditorIntoView: true,
    scrollPastEnd: 1.0,
    highlightGutterLine: true,
    showPrintMargin: false,
    printMargin: false,
    displayIndentGuides: true,
    fontSize: `${FONT_SIZE}px`,
    fontFamily: '"Ricty Diminished Discord", "Ricty Diminished", Ricty, Monaco, consolas, monospace',
    theme: DARK_THEME,
    enableBasicAutocompletion: true,
    enableSnippets: false,
    enableLiveAutocompletion: true,
};

// DOM Content Loaded „Åß„Éï„É≠„É≥„ÉàÂÅ¥„ÅÆË®≠ÂÆöÁ≠â„ÇíÈñãÂßã„Åô„Çã
window.addEventListener('DOMContentLoaded', () => {
    // „Åì„ÅÆ„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´Èñ¢„Åô„ÇãÂÖ®‰Ωì„ÅÆË®≠ÂÆö
    windowSetting()
    .then(() => {
        // ÂàùÊúüÂåñÔºà‰∏ª„Å´ DOM „ÅÆÁîüÊàêÔºâ
        return initialSetting();
    })
    .then(() => {
        // Ace „ÅÆË®≠ÂÆöÈñ¢ÈÄ£
        return editorSetting();
    })
    .then(() => {
        // „Ç§„Éô„É≥„ÉàÂá¶ÁêÜ
        eventSetting();
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº„ÇíÊõ¥Êñ∞„Åó„Å¶Ê∫ñÂÇôÂÆå‰∫Ü
        setStatusBarMessage('üìê: welcome editron');
        setStatusBarIcon(
            '#windowinterfacestatuseditron',
            'green', true,
            'editron initialize success'
        );
    });
}, false);

/**
 * @param {string} text - Ë®≠ÂÆö„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
 */
function setStatusBarMessage(text){
    let message = document.querySelector('#windowinterfacestatusmessage');
    message.textContent = text;
}

/**
 * „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº„ÅÆÂè≥ÂÅ¥„Å´„ÅÇ„Çã„Ç¢„Ç§„Ç≥„É≥„ÅÆÊõ¥Êñ∞„ÇíË°å„ÅÜ
 * @param {string} targetId - ÂØæË±°„Å®„Å™„Çã DOM „ÅÆ ID
 * @param {string} stat - green, yellow, red
 * @param {boolean} add - stat „ÅßÊåáÂÆö„Åï„Çå„ÅüËâ≤„ÇíË®≠ÂÆö„Åô„Çã„Åã„ÄÅËß£Èô§„Åô„Çã„Åã
 * @param {string} title - title Â±ûÊÄß„Å´Ë®≠ÂÆö„Åô„ÇãÊñáÂ≠óÂàó
 */
function setStatusBarIcon(targetId, stat, add, title){
    let icon = document.querySelector(targetId);
    if(add === true){
        icon.classList.add(stat);
    }else{
        icon.classList.remove(stat);
    }
    icon.setAttribute('title', title);
}

/**
 * @return {Promise}
 */
function windowSetting(){
    let fontSize = FONT_SIZE;
    let dark = true;
    // Electron Ëá™‰Ωì„ÅÆ„Ç∫„Éº„É†„ÅØË°å„Çè„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Ë®≠ÂÆö„Åô„Çã
    webFrame.setZoomFactor(1);
    webFrame.setVisualZoomLevelLimits(1, 1);
    webFrame.setLayoutZoomLevelLimits(0, 0);
    return new Promise((resolve) => {
        // header
        let ttl = document.body.querySelector('#windowinterfacetitle');
        let min = document.body.querySelector('#windowinterfacecontrollermin');
        let max = document.body.querySelector('#windowinterfacecontrollermax');
        let cls = document.body.querySelector('#windowinterfacecontrollerclose');
        if(macos === true){
            let head = document.body.querySelector('#windowinterfaceheader');
            let menu = document.body.querySelector('#windowinterfacemenuicon');
            let ctrl = document.body.querySelector('#windowinterfacecontroller');
            head.style.lineHeight = '22px';
            head.style.minHeight  = '22px';
            head.style.maxHeight  = '22px';
            menu.style.minWidth = '4px';
            menu.style.maxWidth = '4px';
            ttl.style.fontSize = 'smaller';
            ttl.style.textAlign = 'center';
            ttl.style.padding = '0px 8px 0px 64px';
            ctrl.style.display = 'none';
        }else{
            min.addEventListener('click', () => {ipcRenderer.send('minimize', true);}, false);
            max.addEventListener('click', () => {ipcRenderer.send('maximize', true);}, false);
            cls.addEventListener('click', () => {ipcRenderer.send('close', true);}, false);
        }
        // footer
        let footer = document.body.querySelector('#windowinterfacefooter');
        // window level event
        window.addEventListener('resize', () => {
            if(editors == null || Array.isArray(editors) !== true){return;}
            editors.forEach((v) => {
                v.resize();
            });
        }, false);
        window.addEventListener('keydown', (evt) => {
            switch(evt.key){
                // ‰øùÂ≠ò„Åä„Çà„Å≥Êõ¥Êñ∞
                case 's':
                    if(evt.ctrlKey === true || evt.metaKey === true){
                        saveEditorSource();
                    }
                    break;
                // ÈñãÁô∫ËÄÖ„ÉÑ„Éº„É´
                case 'i':
                case 'I':
                    if(evt.ctrlKey === true || evt.metaKey === true){
                        ipcRenderer.send('opendevtools', {});
                    }
                    break;
                case 'F12':
                    ipcRenderer.send('opendevtools', {});
                    break;
                // „ÉÜ„Éº„Éû„ÅÆÂèçËª¢
                case 'b':
                case '‚à´':
                    if((evt.ctrlKey === true || evt.metaKey === true) && evt.altKey === true){
                        dark = !dark;
                        editors.forEach((v, index) => {
                            if(dark === true){
                                v.setTheme(DARK_THEME);
                            }else{
                                v.setTheme(LIGHT_THEME);
                            }
                        });
                    }
                    break;
                // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ê∏õ
                case '-':
                case '_':
                    if(evt.ctrlKey === true || evt.metaKey === true){
                        --fontSize;
                        pages.forEach((v, index) => {
                            v.style.fontSize = `${fontSize}px`;
                        });
                    }
                    break;
                // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Â¢ó
                case '=':
                case '+':
                    if(evt.ctrlKey === true || evt.metaKey === true){
                        ++fontSize;
                        pages.forEach((v, index) => {
                            v.style.fontSize = `${fontSize}px`;
                        });
                    }
                    break;
                default:
                    break;
            }
        }, false);
        // ÊúÄÂæå„Å´„Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
        ipcRenderer.on('settitledom', (evt, arg) => {
            ttl.textContent = arg;
            resolve();
        });
        let title = 'webgl - editron';
        ipcRenderer.send('settitle', title);
    });
}

/**
 * @return {Promise}
 */
function initialSetting(){
    return new Promise((resolve) => {
        // ‰∏ä‰∏ã„ÇíÂàÜ„Åë„Çã„Çπ„Éó„É™„ÉÉ„Çø
        let container = document.querySelector('#container');
        let split = new Component.Splitter(container, true);
        split.first.setAttribute('id', 'first');
        split.second.setAttribute('id', 'second');
        split.on('change', (arg) => {
            editors.forEach((v) => {
                v.resize();
            });
            setFrameSize();
        });
        // „Çø„Éñ„Çπ„Éà„É™„ÉÉ„Éó
        let titles = editorMode.map((v) => {return v.title});
        let tabStrip = new Component.TabStrip(split.second, titles, 0);
        tabStrip.on('change', () => {
            editors.forEach((v) => {
                v.resize();
            });
        });
        pages = tabStrip.getAllPage();
        // ‰∏äÊÆµ„ÇíÂ∑¶Âè≥„Å´ÂàÜ„Åë„Çã„Çπ„Éó„É™„ÉÉ„Çø
        let vsplit = new Component.Splitter(split.first, false, 0.2);
        vsplit.on('change', (arg) => {
            setFrameSize();
        });
        vsplit.first.setAttribute('id', 'vfirst');
        vsplit.second.setAttribute('id', 'vsecond');
        // „Éó„É¨„Éì„É•„ÉºÁî®„ÅÆ iframe
        let frame = document.createElement('iframe');
        frame.setAttribute('id', 'frame');
        vsplit.second.appendChild(frame);
        // ‰∏äÊÆµÂ∑¶„Çµ„Ç§„Éâ„Éê„Éº
        let leftBlock = document.createElement('div');
        util.appendStyle(leftBlock, {
            width: '100%',
            height: '100%',
            display: 'flex',
            flexDirection: 'column',
        });
        let buttonBlock = document.createElement('div');
        util.appendStyle(buttonBlock, {
            width: '100%',
            minHeight: `${BUTTON_BLOCK_HEIGHT}px`,
            maxHeight: `${BUTTON_BLOCK_HEIGHT}px`,
            display: 'flex',
            flexDirection: 'row',
            overflow: 'hidden',
            userSelect: 'none',
        });
        let openFolderIcon = document.createElement('img');
        openFolderIcon.setAttribute('id', 'open');
        openFolderIcon.setAttribute('title', '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñã„Åè');
        openFolderIcon.src = './image/folder_plus.svg';
        util.appendStyle(openFolderIcon, {
            width: `${ICON_SIZE}px`,
            height: `${ICON_SIZE}px`,
            margin: ICON_MARGIN,
            cursor: 'pointer',
            filter: 'invert(0.5)',
            userSelect: 'none',
        });
        openFolderIcon.addEventListener('mouseenter', () => {
            openFolderIcon.style.filter = 'invert(1)';
        });
        openFolderIcon.addEventListener('mouseleave', () => {
            openFolderIcon.style.filter = 'invert(0.5)';
        });
        let closeFolderIcon = document.createElement('img');
        closeFolderIcon.setAttribute('id', 'close');
        closeFolderIcon.setAttribute('title', '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñâ„Åò„Çã');
        closeFolderIcon.src = './image/folder_minus.svg';
        util.appendStyle(closeFolderIcon, {
            width: `${ICON_SIZE}px`,
            height: `${ICON_SIZE}px`,
            margin: ICON_MARGIN,
            cursor: 'pointer',
            filter: 'invert(0.5)',
            userSelect: 'none',
        });
        closeFolderIcon.addEventListener('mouseenter', () => {
            closeFolderIcon.style.filter = 'invert(1)';
        });
        closeFolderIcon.addEventListener('mouseleave', () => {
            closeFolderIcon.style.filter = 'invert(0.5)';
        });
        let playIcon = document.createElement('img');
        playIcon.setAttribute('id', 'play');
        playIcon.setAttribute('title', '„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Çí‰øùÂ≠ò„Åó„Éó„É¨„Éì„É•„Éº„ÇíÊõ¥Êñ∞ (Ctrl+s or Command+s)');
        playIcon.src = './image/play.svg';
        util.appendStyle(playIcon, {
            width: `${ICON_SIZE}px`,
            height: `${ICON_SIZE}px`,
            margin: ICON_MARGIN,
            cursor: 'pointer',
            filter: 'invert(0.5)',
            userSelect: 'none',
        });
        playIcon.addEventListener('mouseenter', () => {
            playIcon.style.filter = 'invert(1)';
        });
        playIcon.addEventListener('mouseleave', () => {
            playIcon.style.filter = 'invert(0.5)';
        });
        let stopIcon = document.createElement('img');
        stopIcon.setAttribute('id', 'stop');
        stopIcon.setAttribute('title', '„Éó„É¨„Éì„É•„Éº„ÇíÂÅúÊ≠¢');
        stopIcon.src = './image/stop.svg';
        util.appendStyle(stopIcon, {
            width: `${ICON_SIZE}px`,
            height: `${ICON_SIZE}px`,
            margin: ICON_MARGIN,
            cursor: 'pointer',
            filter: 'invert(0.5)',
            userSelect: 'none',
        });
        stopIcon.addEventListener('mouseenter', () => {
            stopIcon.style.filter = 'invert(1)';
        });
        stopIcon.addEventListener('mouseleave', () => {
            stopIcon.style.filter = 'invert(0.5)';
        });
        let listBlock = document.createElement('div');
        listBlock.setAttribute('id', 'listblock');
        util.appendStyle(listBlock, {
            width: '100%',
            height: '100%',
            display: 'flex',
            flexDirection: 'column',
        });
        // appending
        vsplit.first.appendChild(leftBlock);
        leftBlock.appendChild(buttonBlock);
        leftBlock.appendChild(listBlock);
        buttonBlock.appendChild(openFolderIcon);
        buttonBlock.appendChild(closeFolderIcon);
        buttonBlock.appendChild(playIcon);
        buttonBlock.appendChild(stopIcon);

        resolve();
    });
}

/**
 * @return {Promise}
 */
function editorSetting(){
    return new Promise((resolve) => {
        // „Çø„Éñ„ÅÆÂêÑ„Éö„Éº„Ç∏„Å´„Ç®„Éá„Ç£„Çø„ÇíÈÖçÁΩÆ„ÅóÂàùÊúüÂåñ„Åô„Çã
        pages.forEach((v, index) => {
            let editor = ace.edit(v.id);
            editor.$blockScrolling = Infinity;
            editor.setOptions(EDITOR_OPTION);
            editor.session.setMode(`ace/mode/${editorMode[index].mode}`);
            editor.session.setUseWrapMode(true);
            editor.session.setTabSize(4);

            // event setting
            let vimMode = false;
            // Ë´∏‰∫ãÊÉÖ„Å´„Çà„Çä Command + L „ÅØÂ∞ÅÂç∞„Åô„Çã
            editor.commands.addCommand({
                name: 'disableCtrl-L',
                bindKey: {win: 'Ctrl-L', mac: 'Command-L'},
                exec: () => {},
            });
            // vim „ÅÆ„Ç≠„Éº„Éê„Ç§„É≥„Éâ„Å´Â§âÊõ¥
            editor.commands.addCommand({
                name: 'toggleVimMode',
                bindKey: {win: 'Ctrl-Alt-V', mac: 'Command-Alt-V'},
                exec: () => {
                    if(vimMode !== true){
                        editor.setKeyboardHandler('ace/keyboard/vim');
                    }else{
                        editor.setKeyboardHandler(null);
                    }
                    vimMode = !vimMode;
                },
            });

            // Â§âÊõ¥„Åå„ÅÇ„Å£„Åü„Åì„Å®„ÇíÊ§úÂá∫„Åó„Å¶Â∑¶„Çµ„Ç§„Éâ„Éê„Éº„ÅÆ„É™„Çπ„Éà‰∏ä„Å´„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÇíÂá∫„Åô„Åü„ÇÅ„ÅÆÂá¶ÁêÜ
            editor.session.on('change', () => {
                if(latestResponse != null && latestActive != null && latestResponse.dirs[latestActive] != null){
                    latestResponse.dirs[latestActive].changes = true;
                    items[latestActive].update(null, true)
                }
            });

            editors.push(editor);
        });

        resolve();
    });
}

function eventSetting(){
    // Â∑¶„Çµ„Ç§„Éâ„Éê„Éº‰∏ä„ÅÆ„Éú„Çø„É≥È°û„Å´ÂØæ„Åô„Çã„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö„Åô„Çã
    let open  = document.querySelector('#open');
    let close = document.querySelector('#close');
    let play  = document.querySelector('#play');
    let stop  = document.querySelector('#stop');

    open.addEventListener('click', () => {
        // Â§âÊõ¥Ê∏à„Åø„ÅÆ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÈñã„ÅèÂâç„Å´Â∞ã„Å≠„Çã
        if(latestResponse != null && latestActive != null && items[latestActive].changes === true){
            let message = '„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆÂ§âÊõ¥Âæå„ÄÅ‰∏ÄÂ∫¶„ÇÇÂÆüË°å„Åó„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„ÅØÁ†¥Ê£Ñ„Åï„Çå„Åæ„Åô„ÄÇ\nÊñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñã„ÅÑ„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü';
            nativeDialog('info', message)
            .then((res) => {
                if(res > 0){
                    nativeOpenDirectory();
                }
            });
        }else{
            nativeOpenDirectory();
        }
    }, false);
    close.addEventListener('click', () => {
        // Â§âÊõ¥Ê∏à„Åø„ÅÆ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÈñâ„Åò„Å¶„Åó„Åæ„ÅÜÂâç„Å´Â∞ã„Å≠„Çã
        if(latestResponse != null && latestActive != null && items[latestActive].changes === true){
            let message = '„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆÂ§âÊõ¥Âæå„ÄÅ‰∏ÄÂ∫¶„ÇÇÂÆüË°å„Åó„Å¶„ÅÑ„Å™„ÅÑÂ§âÊõ¥„ÅØÁ†¥Ê£Ñ„Åï„Çå„Åæ„Åô„ÄÇ\nÁèæÂú®„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñâ„Åò„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü';
            nativeDialog('info', message)
            .then((res) => {
                if(res > 0){
                    nativeCloseServer();
                }
            });
        }else{
            nativeCloseServer();
        }
    }, false);
    play.addEventListener('click', () => {
        // Command + s „Å®ÂêåÁ≠â
        saveEditorSource();
    });
    stop.addEventListener('click', () => {
        // iframe „ÅÆ‰∏≠Ë∫´„Å†„Åë„Çí„É™„Çª„ÉÉ„Éà„Åô„Çã
        clearFrame();
        setStatusBarMessage('clear');
        setStatusBarIcon('#windowinterfacestatusfile', 'green', false, 'clear frame');
    });
}

/**
 * Electron „ÇíÁµåÁî±„Åó„Å¶„Éç„Ç§„ÉÜ„Ç£„ÉñÔºà„Åã„Å§„É¢„Éº„ÉÄ„É´Ôºâ„Å™„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÂá∫„Åô
 * @param {string} title - „Çø„Ç§„Éà„É´
 * @param {string} message - „ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏Êú¨Êñá
 * @param {Array.<string>} [buttons] - ÁúÅÁï•ÊôÇ„ÅØ OK, cancel „Å´„Å™„Çã
 *
 */
function nativeDialog(title, message, buttons){
    return new Promise((resolve) => {
        ipcRenderer.once('nativedialog', (arg, res) => {
            resolve(res);
        });
        ipcRenderer.send('nativedialog', {title: title, message: message, buttons: buttons});
    });
}

/**
 * „É≠„Éº„Ç´„É´„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÈñã„Åè„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÂá∫„Åó„ÄÅÁµêÊûú„Å´„Çà„Å£„Å¶„ÅØ„Åù„Çå„ÇíÈñã„ÅÑ„Åü„ÅÇ„Å®
 * Ë™≠„ÅøËæº„Çì„Å†„Éï„Ç°„Ç§„É´„ÅÆÊÉÖÂ†±‰∏ÄË¶ß„Å®ÂÖ±„Å´ÊÉÖÂ†±„ÅåËøî„Åï„Çå„Çã„ÄÇ„Åì„ÅÆ„Å®„Åç„ÄÅ„Éï„Ç°„Ç§„É´„ÅÆÊÉÖÂ†±„Åå
 * Âæó„Çâ„Çå„ÅüÂ†¥Âêà„ÅØ„Çµ„Éº„ÉêÂÆüË£ÖÂÅ¥„Åß„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÇíËµ∑Âãï„Åó„Å¶„ÅÑ„Çã„ÄÇ
 * „Éù„Éº„ÉàÁï™Âè∑„ÅØ„É¨„Çπ„Éù„É≥„Çπ„Å´Âê´„Åæ„Çå„Çã„Åü„ÇÅ„ÄÅiframe „Å´„ÅØ `http://localhost:port/dirname`
 * „ÅÆ„Çà„ÅÜ„Å´ URL „ÇíÊåáÂÆö„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Çã„ÄÇ
 */
function nativeOpenDirectory(){
    ipcRenderer.once('localserverrunning', (arg, res) => {
        if(res === false){
            // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÅüÂ†¥Âêà
            setStatusBarMessage('cancel on project open dialog');
        }else if(res.hasOwnProperty('err') === true){
            // ‰Ωï„Åã„Åó„Çâ„ÅÆ„Ç®„É©„Éº
            setStatusBarMessage(`Error: ${res.err}`);
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'green', false, '');
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'yellow', false, '');
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'red', true, 'project open failed');
            nativeDialog('error', '„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆÊßãÊàê„ÅåÊ≠£„Åó„Åè„Å™„ÅÑ„Åü„ÇÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÈñã„Åë„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', ['OK']);
        }else{
            // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç
            if(Array.isArray(res.dirs) !== true || res.dirs.length === 0){
                setStatusBarMessage(`Error: ${res.err}`);
                setStatusBarIcon('#windowinterfacestatuslocalserver', 'green', false, '');
                setStatusBarIcon('#windowinterfacestatuslocalserver', 'yellow', false, '');
                setStatusBarIcon('#windowinterfacestatuslocalserver', 'red', true, 'project open failed');
                nativeDialog('error', '„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„ÅÆÊßãÊàê„ÅåÊ≠£„Åó„Åè„Å™„ÅÑ„Åã‰∏çÊ≠£„Å™„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„Åô„ÄÇ', ['OK']);
                return;
            }
            setStatusBarMessage(`open project: [ ${res.pwd} ]`)
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'red', false, '');
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'yellow', false, '');
            setStatusBarIcon('#windowinterfacestatuslocalserver', 'green', true, 'project open success');
            // Èñã„ÅèÂâç„Å´„Åô„Åπ„Å¶„Çí„É™„Çª„ÉÉ„Éà
            clearFrame();
            clearList();
            clearEditor();
            let left = document.querySelector('#listblock');
            items = [];
            latestResponse = res;
            latestResponse.dirs.forEach((v, index) => {
                let item = new Component.Item(left, index, v.dirName, false);
                items[index] = item;
                item.on('click', (idx) => {
                    const update = () => {
                        latestActive = idx;
                        setEditorSource(latestResponse.dirs[idx].data);
                        items.forEach((w, i) => {
                            w.update(false, false);
                        });
                        item.update(true, false);
                        setFrameSource(idx);
                        setStatusBarMessage(`start: [ ${latestResponse.dirs[idx].dirName} ]`);
                        setStatusBarIcon('#windowinterfacestatusfile', 'red', false, '');
                        setStatusBarIcon('#windowinterfacestatusfile', 'yellow', false, '');
                        setStatusBarIcon('#windowinterfacestatusfile', 'green', true, 'start success');
                    };
                    // „ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Å´Â§âÊõ¥„ÅåÂä†„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„Å™„Å©„Å´„Çà„ÇäÂàÜÂ≤ê„Åô„Çã
                    if(latestActive != null && idx !== latestActive && items[latestActive].changes === true){
                        let message = `ÁèæÂú®„ÅÆ„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ[ ${latestResponse.dirs[latestActive].dirName} ]„Å´Â§âÊõ¥„ÅåÂä†„Åà„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ\n[ ${latestResponse.dirs[idx].dirName} ] „ÇíË™≠„ÅøËæº„ÇÄ„Å®„Åù„ÅÆÂ§âÊõ¥„ÅØÁ†¥Ê£Ñ„Åï„Çå„Åæ„Åô„ÄÇË™≠„ÅøËæº„Åø„ÇíÈñãÂßã„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`;
                        nativeDialog('info', message)
                        .then((res) => {
                            if(res > 0){
                                update();
                            }
                        });
                    }else{
                        if(idx === latestActive && items[latestActive].changes === true){
                            // ÁèæÂú®„ÅÆ„ÇΩ„Éº„Çπ„Å´Â§âÊõ¥„ÅåÂä†„Åà„Çâ„Çå„Å¶„ÅÑ„Çã„Å®„Åç„Å´ÁèæÂú®„ÅÆ„ÇΩ„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà
                            // „Éï„É¨„Éº„É†„Å†„Åë„ÇíÊõ¥Êñ∞„Åó„Å¶„É™„Çπ„ÉàÁ≠â„ÅØÊìç‰Ωú„Åó„Å™„ÅÑ
                            setFrameSource(idx);
                            setStatusBarMessage(`start: [ ${latestResponse.dirs[idx].dirName} ]`);
                            setStatusBarIcon('#windowinterfacestatusfile', 'red', false, '');
                            setStatusBarIcon('#windowinterfacestatusfile', 'yellow', false, '');
                            setStatusBarIcon('#windowinterfacestatusfile', 'green', true, 'start success');
                        }else{
                            update();
                        }
                    }
                });
            });
        }
    });
    ipcRenderer.send('opendirectory');
}

/**
 * „Çµ„Éº„ÉêÂÆüË£ÖÂÅ¥„ÅßËµ∑Âãï„Åó„Åü„É≠„Éº„Ç´„É´„Çµ„Éº„Éê„ÇíÂÅúÊ≠¢„Åô„Çã
 */
function nativeCloseServer(){
    ipcRenderer.once('localserverclosed', (arg, res) => {
        clearFrame();
        clearList();
        clearEditor();
        setStatusBarMessage(`local server closed`)
        setStatusBarIcon('#windowinterfacestatuslocalserver', 'green', false, '');
    });
    ipcRenderer.send('closelocalserver');
}

/**
 * iframe „ÅÆ‰∏≠Ë∫´„Çí„ÇØ„É™„Ç¢„Åô„Çã
 */
function clearFrame(){
    let frame = document.querySelector('#frame');
    frame.src = 'about:blank';
}

/**
 * Â∑¶„Çµ„Ç§„Éâ„Éê„Éº‰∏ä„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™Âêç‰∏ÄË¶ß„ÇíÂâäÈô§„Åô„Çã
 */
function clearList(){
    let left = document.querySelector('#listblock');
    while(left.children.length > 0){
        left.removeChild(left.children[0]);
    }
}

/**
 * „Ç®„Éá„Ç£„Çø„ÅÆ‰∏≠Ë∫´„Çí„Åô„Åπ„Å¶„ÇØ„É™„Ç¢„Åô„Çã
 */
function clearEditor(){
    latestResponse = null;
    latestActive = null;
    editors.forEach((v, index) => {
        v.setValue('', -1);
    });
}

/**
 * „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊÉÖÂ†±„Çí„Ç®„Éá„Ç£„Çø„Å´ÂèçÊò†„Åô„Çã
 */
function setEditorSource(data){
    editorMode.forEach((v, index) => {
        for(let name in data){
            if(v.name === name){
                editors[index].setValue(data[name].data, -1);
                continue;
            }
        }
    });
}

/**
 * „Ç®„Éá„Ç£„Çø„ÅÆÊÉÖÂ†±„Çí„É¨„Çπ„Éù„É≥„Çπ„Å´ÂèçÊò†„Åó„Åü„ÅÆ„Å°„Çµ„Éº„Éê„Å´„Éó„ÉÉ„Ç∑„É•„ÅóÁâ©ÁêÜÁöÑ„Å´„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åô„Çã
 */
function saveEditorSource(){
    if(latestResponse == null || latestActive == null){return;}
    editorMode.forEach((v, index) => {
        for(let name in latestResponse.dirs[latestActive].data){
            if(v.name === name){
                latestResponse.dirs[latestActive].data[name] = {data: editors[index].getValue(), exists: true};
                continue;
            }
        }
    });
    ipcRenderer.once('savefile', (res) => {
        if(res.hasOwnProperty('err') === true){
            setStatusBarMessage(`Error: ${res.err}`);
            setStatusBarIcon('#windowinterfacestatusfile', 'green', false, '');
            setStatusBarIcon('#windowinterfacestatusfile', 'yellow', false, '');
            setStatusBarIcon('#windowinterfacestatusfile', 'red', true, 'save file failed');
            nativeDialog('error', '„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', ['OK']);
        }else{
            setStatusBarMessage(`save project: [ ${latestResponse.dirs[latestActive].dirName} ]`);
            setStatusBarIcon('#windowinterfacestatusfile', 'red', false, '');
            setStatusBarIcon('#windowinterfacestatusfile', 'yellow', false, '');
            setStatusBarIcon('#windowinterfacestatusfile', 'green', true, 'save file success');
            items[latestActive].update(null, false);
            setFrameSource(latestActive);
        }
    });
    ipcRenderer.send('saveproject', latestResponse.dirs[latestActive]);
}

/**
 * iframe „Å´ URL „ÇíË®≠ÂÆö„Åó„É≠„Éº„Éâ„Åô„Çã
 */
function setFrameSource(index){
    clearFrame();
    let frame = document.querySelector('#frame');
    frame.src = `http://localhost:${latestResponse.port}/${latestResponse.dirs[index].dirName}`;
}

/**
 * iframe „ÅÆ„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö„Åô„Çã
 */
function setFrameSize(){
    let frame = document.querySelector('#frame');
    let bound = frame.parentElement.getBoundingClientRect();
    frame.width = bound.width;
    frame.height = bound.height;
}

